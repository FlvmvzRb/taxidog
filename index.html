<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetBoard - Sistema de Gestão</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos Customizados -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .pet-card, .fleet-card { transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s; }
        #pet-cards-grid .pet-card:hover, .fleet-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .kanban-column { min-height: 400px; }

        /* Modo de Seleção para Agrupamento */
        .selection-mode .ungrouped-pet-card { cursor: pointer; opacity: 0.6; }
        .selection-mode .ungrouped-pet-card:hover { opacity: 1; border-color: #3b82f6; }
        .selection-mode .selected-for-grouping { border: 2px solid #3b82f6; box-shadow: 0 0 0 2px #3b82f6; opacity: 1; }
        
        /* Modo de Edição de Grupo */
        .add-to-group-btn, .remove-from-group-btn { display: none; }
        .edit-mode-active .ungrouped-pet-card .add-to-group-btn { display: inline-flex !important; cursor: pointer; }
        .edit-mode-active .editing-this-group .group-pet .remove-from-group-btn { display: inline-flex !important; cursor: pointer; }

        /* Estilos do Calendário */
        .calendar-day.selected-date { background-color: #2563eb; color: white; border-radius: 50%; }
        .calendar-day:not(.disabled-date):hover { background-color: #dbeafe; border-radius: 50%; }
        
        /* Estilo para tarefa concluída */
        .task-completed { text-decoration: line-through; color: #6b7280; } /* gray-500 */
        
        /* Cores por Serviço */
        .service-banho { background-color: #ddd6fe; color: #5b21b6; }
        .dark .service-banho { background-color: #5b21b6; color: #ddd6fe; }
        .service-creche { background-color: #bbf7d0; color: #166534; }
        .dark .service-creche { background-color: #16a34a; color: #bbf7d0; }
        .service-hotel { background-color: #bfdbfe; color: #1e40af; }
        .dark .service-hotel { background-color: #2563eb; color: #bfdbfe; }
        .service-clinica { background-color: #fde68a; color: #92400e; }
        .dark .service-clinica { background-color: #ca8a04; color: #fde68a; }
        .service-outros { background-color: #d1d5db; color: #1f2937; }
        .dark .service-outros { background-color: #4b5563; color: #d1d5db; }

        /* Cores de Status - Sobrescrevem as de serviço */
        .status-bg-buscando { background-color: #fcd34d !important; color: #78350f !important; }
        .dark .status-bg-buscando { background-color: #d97706 !important; color: #fffbeb !important; }
        .status-bg-coletado { background-color: #4ade80 !important; color: #15803d !important; }
        .dark .status-bg-coletado { background-color: #22c55e !important; color: #dcfce7 !important; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- TELA DE LOGIN -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <div class="text-center">
                <i class="fa-solid fa-paw text-4xl text-blue-600"></i>
                <h1 class="text-3xl font-bold mt-2">PetBoard</h1>
                <p class="text-gray-500 dark:text-gray-400">Acesse para gerenciar as rotas</p>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700" placeholder="seu@email.com">
                <input type="password" id="password" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700" placeholder="Sua senha">
                <button type="submit" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">Entrar</button>
            </form>
            <p id="login-error" class="text-red-500 text-sm text-center h-4 mt-4"></p>
        </div>
    </div>

    <!-- APLICAÇÃO PRINCIPAL -->
    <div id="app-view" class="hidden">
        <header class="fixed top-0 left-0 w-full bg-white dark:bg-gray-800 shadow-md z-40">
             <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-blue-600"><i class="fa-solid fa-paw"></i> PetBoard</h1>
                    <nav class="hidden md:flex items-center gap-2">
                        <button data-tab="painel" class="nav-tab active-tab px-3 py-1 rounded-lg font-semibold bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300"><i class="fa-solid fa-columns mr-2"></i>Painel</button>
                        <button data-tab="cards" class="nav-tab px-3 py-1 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fa-solid fa-id-card mr-2"></i>Cards</button>
                        <button data-tab="frota" class="nav-tab px-3 py-1 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fa-solid fa-truck mr-2"></i>Frota</button>
                    </nav>
                </div>
                <div class="flex items-center gap-4">
                    <span id="user-email" class="text-sm"></span>
                    <button id="logout-btn" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg text-sm"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
            <div class="md:hidden border-t dark:border-gray-700">
                <nav class="flex justify-around items-center p-1">
                    <button data-tab="painel" class="nav-tab active-tab flex-1 text-center py-2 rounded-lg font-semibold bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300"><i class="fa-solid fa-columns"></i></button>
                    <button data-tab="cards" class="nav-tab flex-1 text-center py-2 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fa-solid fa-id-card"></i></button>
                    <button data-tab="frota" class="nav-tab flex-1 text-center py-2 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fa-solid fa-truck"></i></button>
                </nav>
            </div>
        </header>

        <main class="pt-28 md:pt-20">
            <!-- ABA PAINEL DO DIA -->
            <div id="painel-tab" class="tab-content p-2 md:p-4">
                <div class="mb-4 flex flex-wrap items-center gap-4">
                    <input type="date" id="painel-date-filter" class="bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-lg px-3 py-1.5">
                    <select id="painel-route-filter" class="bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-lg px-3 py-1.5">
                        <option value="all">Todas as Rotas</option>
                        <option value="Rota 1">Rota 1</option><option value="Rota 2">Rota 2</option><option value="Rota 3">Rota 3</option><option value="Avulso">Avulso</option>
                    </select>
                </div>
                <div id="kanban-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
            </div>

            <!-- ABA CARDS -->
            <div id="cards-tab" class="tab-content hidden p-2 md:p-4">
                 <div class="mb-4 flex flex-wrap items-center gap-4">
                    <input type="search" id="card-search-input" placeholder="Buscar por pet ou tutor..." class="flex-grow bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-lg px-3 py-1.5">
                    <select id="card-route-filter" class="bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-lg px-3 py-1.5">
                         <option value="all">Todas as Rotas</option>
                         <option value="Rota 1">Rota 1</option><option value="Rota 2">Rota 2</option><option value="Rota 3">Rota 3</option><option value="Avulso">Avulso</option>
                    </select>
                    <button id="new-pet-card-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-3 py-1.5 rounded-lg"><i class="fa-solid fa-plus mr-2"></i>Novo Card</button>
                </div>
                <div id="pet-cards-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
            </div>

            <!-- ABA FROTA -->
            <div id="frota-tab" class="tab-content hidden p-2 md:p-4">
                 <div id="fleet-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Cards da frota são renderizados aqui -->
                 </div>
            </div>
        </main>
        
        <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div id="generic-modal-content" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-2xl m-4 transform transition-all overflow-y-auto max-h-[90vh]"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, getDoc, runTransaction, updateDoc, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E INICIALIZAÇÃO ---
        const firebaseConfig = {
            apiKey: "AIzaSyCKOXqvwo9wA7pMDdoLMMtUiQSKDW9bygU",
            authDomain: "taxidog-593d8.firebaseapp.com",
            projectId: "taxidog-593d8",
            storageBucket: "taxidog-593d8.appspot.com",
            messagingSenderId: "419627111718",
            appId: "1:419627111718:web:805c187a118d199aa9dde7"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- ESTADO DA APLICAÇÃO ---
        let allPets = [];
        let fleetData = {};
        let currentSchedule = null;
        let selectedForGrouping = [];

        // --- REFERÊNCIAS DO DOM ---
        const loginView = document.getElementById('login-view'), appView = document.getElementById('app-view'),
              loginForm = document.getElementById('login-form'), loginError = document.getElementById('login-error'),
              userEmailSpan = document.getElementById('user-email'), logoutBtn = document.getElementById('logout-btn');

        // --- LÓGICA DE AUTENTICAÇÃO REAL DO FIREBASE ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginView.classList.add('hidden');
                appView.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                initializeAppLogic(user); 
            } else {
                appView.classList.add('hidden');
                loginView.classList.remove('hidden');
                userEmailSpan.textContent = '';
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';

            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                        loginError.textContent = 'A criar conta...';
                        createUserWithEmailAndPassword(auth, email, password)
                           .catch(err => {
                               loginError.textContent = 'Erro ao criar conta: ' + err.message;
                           });
                    } else {
                        loginError.textContent = 'Email ou senha incorretos.';
                    }
                });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // --- LÓGICA PRINCIPAL ---
        async function initializeAppLogic(user) {
            await ensureFleetDataExists();
            setupNavigation();
            setupCardsTab();
            setupPainelTab();
            setupFrotaTab();
        }

        // --- NAVEGAÇÃO ---
        function setupNavigation() {
            const navTabs = document.querySelectorAll('.nav-tab'), tabContents = document.querySelectorAll('.tab-content');
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    navTabs.forEach(t => t.classList.remove('active-tab', 'bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300'));
                    document.querySelectorAll(`.nav-tab[data-tab="${tabName}"]`).forEach(t => t.classList.add('active-tab', 'bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300'));
                    tabContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(`${tabName}-tab`).classList.remove('hidden');
                    if (tabName === 'painel') loadScheduleForDate();
                });
            });
        }
        
        // --- MODAIS ---
        const modal = document.getElementById('generic-modal'), modalContent = document.getElementById('generic-modal-content');
        function openModal(html) { modalContent.innerHTML = html; modal.classList.remove('hidden'); }
        function closeModal() { modal.classList.add('hidden'); modalContent.innerHTML = ''; }
        modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

        function openConfirmationModal(message, onConfirm) {
            const modalHTML = `
                <h3 class="text-lg font-bold mb-4">Confirmação</h3>
                <p>${message}</p>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-confirm-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Cancelar</button>
                    <button id="do-confirm-btn" class="px-4 py-2 rounded-lg bg-green-600 text-white">Confirmar</button>
                </div>
            `;
            openModal(modalHTML);
            document.getElementById('do-confirm-btn').onclick = () => { onConfirm(); closeModal(); };
            document.getElementById('cancel-confirm-btn').onclick = closeModal;
        }

        // --- HELPERS ---
        function getServiceColorClass(services) {
            if (!services || services.length === 0) return 'service-outros';
            const mainService = services[0].toLowerCase();
            switch (mainService) {
                case 'banho': return 'service-banho';
                case 'creche': return 'service-creche';
                case 'hotel': return 'service-hotel';
                case 'clinica': return 'service-clinica';
                default: return 'service-outros';
            }
        }
        
        // --- ABA CARDS ---
        function setupCardsTab() {
            onSnapshot(collection(db, 'pets'), (snapshot) => {
                allPets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyCardFiltersAndRender();
                if(document.getElementById('painel-tab').style.display !== 'hidden') loadScheduleForDate();
            });
            document.getElementById('new-pet-card-btn').addEventListener('click', () => openPetModal());
            document.getElementById('card-search-input').addEventListener('input', applyCardFiltersAndRender);
            document.getElementById('card-route-filter').addEventListener('change', applyCardFiltersAndRender);
        }
        
        function applyCardFiltersAndRender() {
            const searchTerm = document.getElementById('card-search-input').value.toLowerCase();
            const selectedRoute = document.getElementById('card-route-filter').value;
            const filteredPets = allPets.filter(pet => (pet.petName.toLowerCase().includes(searchTerm) || pet.tutorName.toLowerCase().includes(searchTerm)) && (selectedRoute === 'all' || pet.defaultRoute === selectedRoute));
            renderPetCards(filteredPets);
        }

        function renderPetCards(pets) {
            const grid = document.getElementById('pet-cards-grid');
            grid.innerHTML = pets.length ? '' : `<p class="col-span-full text-center text-gray-500">Nenhum pet encontrado.</p>`;
            pets.forEach(pet => {
                const card = document.createElement('div');
                const serviceClass = getServiceColorClass(pet.services);
                card.className = `pet-card rounded-lg shadow p-4 flex flex-col gap-2 cursor-pointer ${serviceClass}`;
                card.innerHTML = `<h3 class="font-bold text-lg">${pet.petName}</h3><p class="text-sm"><i class="fa-solid fa-user mr-2"></i>${pet.tutorName}</p><p class="text-sm"><i class="fa-solid fa-route mr-2"></i>${pet.defaultRoute}</p>`;
                card.addEventListener('click', () => openPetModal(pet));
                grid.appendChild(card);
            });
        }
        
        async function openPetModal(pet = {}) {
            const isEditing = !!pet.id;
            const petDoc = isEditing ? (await getDoc(doc(db, "pets", pet.id))).data() : {};
            const scheduledDates = petDoc?.scheduledDates || [];
            const services = petDoc?.services || [];
            
            const modalHTML = `
                <form id="pet-form">
                    <h2 class="text-2xl font-bold mb-6">${isEditing ? 'Editar Ficha' : 'Nova Ficha'}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="petName" placeholder="Nome do Pet" required class="w-full p-2 border rounded dark:bg-gray-700" value="${pet.petName || ''}">
                        <input type="text" name="tutorName" placeholder="Nome do Tutor" required class="w-full p-2 border rounded dark:bg-gray-700" value="${pet.tutorName || ''}">
                        <input type="tel" name="phone" placeholder="Telefone" class="w-full p-2 border rounded dark:bg-gray-700" value="${pet.phone || ''}">
                        <select name="defaultRoute" required class="w-full p-2 border rounded dark:bg-gray-700">
                            <option value="Rota 1" ${pet.defaultRoute === 'Rota 1' ? 'selected' : ''}>Rota 1</option>
                            <option value="Rota 2" ${pet.defaultRoute === 'Rota 2' ? 'selected' : ''}>Rota 2</option>
                            <option value="Rota 3" ${pet.defaultRoute === 'Rota 3' ? 'selected' : ''}>Rota 3</option>
                            <option value="Avulso" ${pet.defaultRoute === 'Avulso' ? 'selected' : ''}>Avulso</option>
                        </select>
                        <textarea name="address" placeholder="Endereço" class="w-full p-2 border rounded md:col-span-2 dark:bg-gray-700">${pet.address || ''}</textarea>
                         <fieldset class="mt-4 border p-3 rounded md:col-span-2">
                            <legend class="px-2 font-semibold">Serviços</legend>
                            <div class="flex flex-wrap gap-x-6 gap-y-2">
                                <label class="flex items-center gap-2"><input type="checkbox" name="services" value="Banho" ${services.includes('Banho') ? 'checked' : ''}> Banho</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="services" value="Creche" ${services.includes('Creche') ? 'checked' : ''}> Creche</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="services" value="Hotel" ${services.includes('Hotel') ? 'checked' : ''}> Hotel</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="services" value="Clinica" ${services.includes('Clinica') ? 'checked' : ''}> Clinica</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="services" value="Outros" ${services.includes('Outros') ? 'checked' : ''}> Outros</label>
                            </div>
                        </fieldset>
                    </div>
                    ${isEditing ? `<fieldset class="mt-4 border p-3 rounded"><legend class="px-2 font-semibold">Agendar Datas</legend><div id="calendar-container"></div></fieldset>` : ''}
                    <div class="mt-6 flex justify-between items-center">
                        <div>${isEditing ? `<button type="button" id="delete-pet-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700"><i class="fa-solid fa-trash"></i></button>` : ''}</div>
                        <div class="flex gap-3">
                           <button type="button" id="modal-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Cancelar</button>
                           <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Salvar</button>
                        </div>
                    </div>
                </form>`;
            openModal(modalHTML);

            document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);

            if (isEditing) {
                renderCalendar('calendar-container', pet, scheduledDates);
                document.getElementById('delete-pet-btn').addEventListener('click', () => deletePet(pet));
            }
            document.getElementById('pet-form').addEventListener('submit', (e) => savePet(e, pet, isEditing));
        }

        async function savePet(e, pet, isEditing) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const services = Array.from(form.querySelectorAll('input[name="services"]:checked')).map(cb => cb.value);

            const petData = {
                petName: formData.get('petName'),
                tutorName: formData.get('tutorName'),
                phone: formData.get('phone'),
                address: formData.get('address'),
                defaultRoute: formData.get('defaultRoute'),
                services: services
            };
            
            try {
                if (isEditing) {
                    const oldRoute = pet.defaultRoute;
                    const newRoute = petData.defaultRoute;

                    if (oldRoute && newRoute && oldRoute !== newRoute) {
                        const petDocSnap = await getDoc(doc(db, "pets", pet.id));
                        const scheduledDates = petDocSnap.data()?.scheduledDates || [];
                        
                        for (const dateStr of scheduledDates) {
                            const scheduleRef = doc(db, "schedules", dateStr);
                            await runTransaction(db, async (transaction) => {
                                const scheduleDoc = await transaction.get(scheduleRef);
                                if (!scheduleDoc.exists()) return;

                                const data = scheduleDoc.data();
                                
                                if (data.routes?.[oldRoute]?.pets) {
                                    const petIndex = data.routes[oldRoute].pets.findIndex(p => p.id === pet.id);
                                    if (petIndex > -1) {
                                        const [petEntry] = data.routes[oldRoute].pets.splice(petIndex, 1);
                                        
                                        if (!data.routes[newRoute]) {
                                            data.routes[newRoute] = { pets: [], groups: {}, observations: [] };
                                        }
                                        data.routes[newRoute].pets.push(petEntry);
                                        transaction.update(scheduleRef, { routes: data.routes });
                                    }
                                }
                            });
                        }
                    }
                    await setDoc(doc(db, "pets", pet.id), petData, { merge: true });
                } else {
                    await addDoc(collection(db, "pets"), petData);
                }
                closeModal();
            } catch (error) { 
                console.error("Erro ao salvar pet:", error);
                alert("Ocorreu um erro ao salvar: " + error.message);
            }
        }

        function deletePet(pet) {
            openConfirmationModal(`Tem a certeza que quer apagar a ficha de ${pet.petName}? Esta ação não pode ser desfeita.`, async () => {
                try {
                    await deleteDoc(doc(db, "pets", pet.id));
                } catch (error) { console.error("Erro ao apagar pet:", error); }
            });
        }
        
        // --- CALENDÁRIO ---
        function renderCalendar(containerId, pet, scheduledDates) {
            const container = document.getElementById(containerId);
            let date = new Date();
            function draw() {
                container.innerHTML = `<div class="flex items-center justify-between mb-2"><button id="prev-month" class="px-2 py-1">&lt;</button><h3 class="font-bold">${date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}</h3><button id="next-month" class="px-2 py-1">&gt;</button></div><div class="grid grid-cols-7 gap-1 text-center text-xs"><div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div></div><div id="calendar-days" class="grid grid-cols-7 gap-1 text-center"></div>`;
                const daysContainer = document.getElementById('calendar-days');
                const month = date.getMonth(), year = date.getFullYear();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDay; i++) { daysContainer.innerHTML += `<div></div>`; }
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const isSelected = scheduledDates.includes(dayStr);
                    daysContainer.innerHTML += `<div class="p-1 calendar-day cursor-pointer ${isSelected ? 'selected-date' : ''}" data-date="${dayStr}">${i}</div>`;
                }
                document.getElementById('prev-month').onclick = () => { date.setMonth(date.getMonth() - 1); draw(); };
                document.getElementById('next-month').onclick = () => { date.setMonth(date.getMonth() + 1); draw(); };
                document.querySelectorAll('.calendar-day').forEach(day => day.onclick = () => toggleSchedule(pet, day.dataset.date));
            }
            draw();
        }

        async function toggleSchedule(pet, dateStr) {
            const petRef = doc(db, "pets", pet.id);
            await runTransaction(db, async (transaction) => {
                const petDoc = await transaction.get(petRef);
                const scheduleRef = doc(db, "schedules", dateStr);
                const scheduleDoc = await transaction.get(scheduleRef);
                let petSchedules = petDoc.data()?.scheduledDates || [];
                let scheduleData = scheduleDoc.exists() ? scheduleDoc.data() : { routes: {} };
                const route = pet.defaultRoute;
                if (!scheduleData.routes[route]) scheduleData.routes[route] = { pets: [], groups: {}, observations: [] };
                if (petSchedules.includes(dateStr)) {
                    petSchedules = petSchedules.filter(d => d !== dateStr);
                    scheduleData.routes[route].pets = scheduleData.routes[route].pets.filter(p => p.id !== pet.id);
                } else {
                    petSchedules.push(dateStr);
                    scheduleData.routes[route].pets.push({ id: pet.id, status: 'pendente' });
                }
                transaction.set(petRef, { scheduledDates: petSchedules }, { merge: true });
                transaction.set(scheduleRef, scheduleData, { merge: true });
            });
            openPetModal(pet);
        }

        // --- ABA PAINEL KANBAN ---
        function setupPainelTab() {
            const dateFilter = document.getElementById('painel-date-filter');
            dateFilter.valueAsDate = new Date();
            dateFilter.addEventListener('change', loadScheduleForDate);
            document.getElementById('painel-route-filter').addEventListener('change', renderKanbanBoard);
            loadScheduleForDate();
        }
        
        function loadScheduleForDate() {
            const dateStr = document.getElementById('painel-date-filter').value;
            if (!dateStr) { document.getElementById('kanban-board').innerHTML = ''; return; }
            onSnapshot(doc(db, "schedules", dateStr), (doc) => {
                currentSchedule = doc.exists() ? { id: doc.id, ...doc.data() } : null;
                renderKanbanBoard();
            });
        }

        function renderKanbanBoard() {
            const board = document.getElementById('kanban-board');
            const routeFilter = document.getElementById('painel-route-filter').value;
            const routes = ["Rota 1", "Rota 2", "Rota 3", "Avulso"];
            board.innerHTML = '';
            routes.filter(r => routeFilter === 'all' || r === routeFilter).forEach(routeName => {
                const column = document.createElement('div');
                const routeId = routeName.replace(' ', '');
                column.id = `column-${routeId}`;
                column.className = 'kanban-column bg-gray-200 dark:bg-gray-800 rounded-lg p-3 flex flex-col gap-3';
                column.innerHTML = `<h3 class="font-bold text-lg">${routeName}</h3><div class="flex gap-2"><button class="group-btn flex-1 text-sm py-1 px-2 rounded bg-blue-500 text-white" data-route="${routeName}">Agrupar</button><button class="add-obs-btn flex-1 text-sm py-1 px-2 rounded bg-green-500 text-white" data-route="${routeName}">OBS</button></div><div id="obs-container-${routeId}" class="space-y-1 text-xs"></div><div id="pets-container-${routeId}" class="space-y-3 flex-grow"></div>`;
                board.appendChild(column);
                renderKanbanColumnContent(routeName, currentSchedule?.routes?.[routeName] || {});
            });
        }
        
        function renderKanbanColumnContent(routeName, routeData) {
            const routeId = routeName.replace(' ', '');
            const obsContainer = document.getElementById(`obs-container-${routeId}`), petsContainer = document.getElementById(`pets-container-${routeId}`);
            obsContainer.innerHTML = '';
            (routeData.observations || []).forEach(obs => {
                const obsEl = document.createElement('div');
                obsEl.className = 'bg-yellow-100 dark:bg-yellow-900 p-1.5 rounded-md flex justify-between items-center';
                obsEl.innerHTML = `<span>${obs.text}</span> <i class="fa-solid fa-trash-can cursor-pointer text-red-500 hover:text-red-700"></i>`;
                obsEl.querySelector('i').onclick = () => deleteObservation(routeName, obs.id);
                obsContainer.appendChild(obsEl);
            });
            petsContainer.innerHTML = '';
            const petsInRoute = (routeData.pets || []).map(p => ({ ...p, ...allPets.find(ap => ap.id === p.id) })).filter(p => p.petName);
            Object.entries(routeData.groups || {}).forEach(([groupId, groupData]) => {
                const groupContainer = document.createElement('div');
                groupContainer.className = 'group-container p-2 rounded-lg bg-gray-300 dark:bg-gray-900';
                const gridClass = routeName === 'Avulso' ? 'space-y-2' : 'grid grid-cols-2 gap-2';
                groupContainer.innerHTML = `<div class="flex justify-between items-center mb-2"><h4 class="font-bold">${groupData.name}</h4><div class="flex gap-2"><button class="edit-group-btn text-xs" data-group-id="${groupId}" data-route-name="${routeName}"><i class="fa-solid fa-pencil"></i></button><button class="ungroup-btn text-xs" data-group-id="${groupId}" data-route-name="${routeName}"><i class="fa-solid fa-sign-out-alt"></i></button></div></div><div class="${gridClass} group-pets-container"></div>`;
                petsContainer.appendChild(groupContainer);
                const groupPetsContainer = groupContainer.querySelector('.group-pets-container');
                petsInRoute.filter(p => p.groupId === groupId).forEach(p => groupPetsContainer.appendChild(createKanbanPetCard(p, routeName, true)));
            });
            
            const ungroupedTitle = document.createElement('h4');
            ungroupedTitle.className = 'text-sm font-semibold mt-4';
            ungroupedTitle.textContent = 'Não Agrupados';
            petsContainer.appendChild(ungroupedTitle);
            
            const ungroupedContainer = document.createElement('div');
            ungroupedContainer.className = routeName === 'Avulso' ? 'space-y-2' : 'grid grid-cols-2 gap-2';
            petsContainer.appendChild(ungroupedContainer);

            petsInRoute.filter(p => !p.groupId).forEach(p => ungroupedContainer.appendChild(createKanbanPetCard(p, routeName, false)));
            
            document.querySelectorAll('.group-btn').forEach(b => b.onclick = () => toggleGroupingMode(b.dataset.route, b));
            document.querySelectorAll('.add-obs-btn').forEach(b => b.onclick = () => openObservationModal(b.dataset.route));
            document.querySelectorAll('.edit-group-btn').forEach(b => b.onclick = () => toggleEditGroupMode(b.dataset.routeName, b.dataset.groupId, b));
            document.querySelectorAll('.ungroup-btn').forEach(b => b.onclick = () => unGroup(b.dataset.routeName, b.dataset.groupId));
        }

        function createKanbanPetCard(pet, routeName, isGrouped) {
            const card = document.createElement('div');
            const serviceClass = getServiceColorClass(pet.services);
            
            let statusClass = '';
            if (pet.status === 'buscando') statusClass = 'status-bg-buscando';
            else if (pet.status === 'coletado') statusClass = 'status-bg-coletado';

            card.className = `kanban-pet-card rounded-lg p-2 shadow flex justify-between items-center cursor-pointer ${isGrouped ? 'group-pet' : 'ungrouped-pet-card'} ${statusClass || serviceClass}`;
            card.dataset.petId = pet.id;
            
            let html = `<div class="flex flex-col"><h4 class="font-bold text-sm">${pet.petName}</h4></div><div class="flex items-center gap-1"><button class="add-to-group-btn text-green-500" data-pet-id="${pet.id}"><i class="fa-solid fa-plus-circle"></i></button><button class="remove-from-group-btn text-red-500" data-pet-id="${pet.id}"><i class="fa-solid fa-minus-circle"></i></button>`;
            if (routeName === 'Avulso') html += `<button class="status-btn text-xs px-1.5 py-0.5 rounded bg-yellow-500 text-white" data-status="buscando">B</button><button class="status-btn text-xs px-1.5 py-0.5 rounded bg-green-500 text-white" data-status="coletado">C</button><button class="status-btn text-xs px-1.5 py-0.5 rounded bg-gray-500 text-white" data-status="pendente">R</button>`;
            html += '</div>';
            card.innerHTML = html;

            card.addEventListener('click', (e) => {
                const column = e.currentTarget.closest('.kanban-column');
                if (e.target.closest('button') || column.classList.contains('selection-mode') || column.classList.contains('edit-mode-active')) {
                    return;
                }
                openKanbanPetDetailsModal(pet);
            });
            
            card.querySelectorAll('.status-btn').forEach(b => b.onclick = () => setPetStatus(pet.id, routeName, b.dataset.status));
            return card;
        }
        
        function openKanbanPetDetailsModal(pet) {
            if (!pet || !pet.petName) return;
            const servicesHTML = pet.services && pet.services.length > 0 
                ? pet.services.map(s => `<span class="bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded-full text-xs font-medium">${s}</span>`).join(' ')
                : '<span class="text-xs text-gray-500">Nenhum serviço</span>';

            const modalHTML = `
                <div class="flex justify-between items-start">
                    <h2 class="text-3xl font-bold mb-4">${pet.petName}</h2>
                    <button id="modal-close-btn" class="text-2xl">&times;</button>
                </div>
                <div class="space-y-4 mt-4 text-left">
                    <div class="p-2 border-b"><h3 class="font-semibold text-sm text-gray-500">Tutor</h3><p class="text-lg">${pet.tutorName || 'Não informado'}</p></div>
                    <div class="p-2 border-b"><h3 class="font-semibold text-sm text-gray-500">Telefone</h3><p class="text-lg">${pet.phone || 'Não informado'}</p></div>
                    <div class="p-2 border-b"><h3 class="font-semibold text-sm text-gray-500">Endereço</h3><p class="text-lg">${pet.address || 'Não informado'}</p></div>
                    <div class="p-2 border-b"><h3 class="font-semibold text-sm text-gray-500">Rota Padrão</h3><p class="text-lg">${pet.defaultRoute || 'Não informada'}</p></div>
                    <div><h3 class="font-semibold text-sm text-gray-500">Serviços Agendados</h3><div class="flex flex-wrap gap-2 mt-1 p-2">${servicesHTML}</div></div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button id="modal-close-btn-2" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Fechar</button>
                </div>`;
            openModal(modalHTML);
            document.getElementById('modal-close-btn').onclick = closeModal;
            document.getElementById('modal-close-btn-2').onclick = closeModal;
        }

        function openObservationModal(routeName) {
            const modalHTML = `
                <h3 class="text-lg font-bold mb-4">Adicionar Observação para ${routeName}</h3>
                <form id="obs-form">
                    <textarea name="obs-text" class="w-full p-2 border rounded dark:bg-gray-700" placeholder="Digite a observação..."></textarea>
                    <div class="mt-4 flex justify-end gap-2">
                         <button type="button" id="modal-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Salvar</button>
                    </div>
                </form>
            `;
            openModal(modalHTML);
            document.getElementById('modal-cancel-btn').onclick = closeModal;
            document.getElementById('obs-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const text = e.target['obs-text'].value;
                if(text) saveObservation(routeName, text);
                closeModal();
            });
        }

        async function updateSchedule(updateFn) {
            if (!currentSchedule) return;
            const scheduleRef = doc(db, "schedules", currentSchedule.id);
            await runTransaction(db, async transaction => {
                const scheduleDoc = await transaction.get(scheduleRef);
                const scheduleData = scheduleDoc.data();
                const newScheduleData = updateFn(scheduleData);
                transaction.set(scheduleRef, newScheduleData);
            });
        }
        
        async function setPetStatus(petId, routeName, newStatus) { await updateSchedule(data => { const petIndex = data.routes[routeName].pets.findIndex(p => p.id === petId); if (petIndex > -1) data.routes[routeName].pets[petIndex].status = newStatus; return data; }); }
        async function saveObservation(routeName, text) { await updateSchedule(data => { if (!data.routes[routeName].observations) data.routes[routeName].observations = []; data.routes[routeName].observations.push({ id: crypto.randomUUID(), text }); return data; }); }
        async function deleteObservation(routeName, obsId) { await updateSchedule(data => { data.routes[routeName].observations = data.routes[routeName].observations.filter(o => o.id !== obsId); return data; }); }
        function toggleGroupingMode(routeName, btn) {
            const column = btn.closest('.kanban-column');
            column.classList.toggle('selection-mode');
            if(column.classList.contains('selection-mode')) {
                btn.textContent = 'Criar Remessa';
                btn.onclick = () => createRemessa(routeName, btn);
                column.querySelectorAll('.ungrouped-pet-card').forEach(card => card.onclick = () => { card.classList.toggle('selected-for-grouping'); const petId = card.dataset.petId; if(selectedForGrouping.includes(petId)) selectedForGrouping = selectedForGrouping.filter(id => id !== petId); else selectedForGrouping.push(petId); });
            } else {
                btn.textContent = 'Agrupar';
                selectedForGrouping = [];
                column.querySelectorAll('.pet-card').forEach(card => card.classList.remove('selected-for-grouping'));
                btn.onclick = () => toggleGroupingMode(routeName, btn);
            }
        }
        function createRemessa(routeName, btn) {
            if (selectedForGrouping.length === 0) { alert('Selecione pelo menos um pet!'); return; }
            const modalHTML = `<h3 class="text-lg font-bold mb-4">Nome da Remessa</h3><form id="group-form"><input name="group-name" class="w-full p-2 border rounded dark:bg-gray-700" placeholder="Ex: Manhã - Zona Sul"><div class="mt-4 flex justify-end"><button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Criar</button></div></form>`;
            openModal(modalHTML);
            document.getElementById('group-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const groupName = e.target['group-name'].value; if(!groupName) return;
                const groupId = crypto.randomUUID();
                await updateSchedule(data => {
                    if (!data.routes[routeName].groups) data.routes[routeName].groups = {};
                    data.routes[routeName].groups[groupId] = { name: groupName };
                    selectedForGrouping.forEach(petId => { const petIndex = data.routes[routeName].pets.findIndex(p => p.id === petId); if (petIndex > -1) data.routes[routeName].pets[petIndex].groupId = groupId; });
                    return data;
                });
                selectedForGrouping = [];
                toggleGroupingMode(routeName, btn);
                closeModal();
            });
        }
        async function unGroup(routeName, groupId) { await updateSchedule(data => { delete data.routes[routeName].groups[groupId]; data.routes[routeName].pets.forEach(pet => { if(pet.groupId === groupId) delete pet.groupId; }); return data; }); }
        
        function toggleEditGroupMode(routeName, groupId, btn) {
            const column = btn.closest('.kanban-column');
            const groupContainer = btn.closest('.group-container');
            
            const isEditingNow = column.classList.contains('edit-mode-active');
            
            // Turn off any other editing group first
            document.querySelectorAll('.edit-mode-active').forEach(c => c.classList.remove('edit-mode-active'));
            document.querySelectorAll('.editing-this-group').forEach(g => g.classList.remove('editing-this-group'));
            document.querySelectorAll('.edit-group-btn').forEach(b => b.innerHTML = `<i class="fa-solid fa-pencil"></i>`);
            
            if (!isEditingNow || groupContainer.dataset.editingGroupId !== groupId) {
                 column.classList.add('edit-mode-active');
                 groupContainer.classList.add('editing-this-group');
                 groupContainer.dataset.editingGroupId = groupId;
                 btn.innerHTML = `<i class="fa-solid fa-check"></i>`;

                column.querySelectorAll('.ungrouped-pet-card .add-to-group-btn').forEach(addBtn => {
                    addBtn.onclick = () => addPetToGroup(routeName, addBtn.dataset.petId, groupId);
                });
                groupContainer.querySelectorAll('.group-pet .remove-from-group-btn').forEach(removeBtn => {
                    removeBtn.onclick = () => removePetFromGroup(routeName, removeBtn.dataset.petId);
                });
            }
        }
        async function addPetToGroup(routeName, petId, groupId) { await updateSchedule(data => { const idx = data.routes[routeName].pets.findIndex(p => p.id === petId); if(idx > -1) data.routes[routeName].pets[idx].groupId = groupId; return data; }); }
        async function removePetFromGroup(routeName, petId) { await updateSchedule(data => { const idx = data.routes[routeName].pets.findIndex(p => p.id === petId); if(idx > -1) delete data.routes[routeName].pets[idx].groupId; return data; }); }

        // --- ABA FROTA ---
        async function ensureFleetDataExists() {
            const vehicleNames = ["Strada", "Montana", "Fiorino"];
            for (const name of vehicleNames) {
                const vehicleRef = doc(db, "fleet", name);
                const docSnap = await getDoc(vehicleRef);
                if (!docSnap.exists()) {
                    try {
                        await setDoc(vehicleRef, {
                            name: name,
                            pendingMaintenance: [],
                            history: []
                        });
                    } catch (error) {
                        console.error(`Failed to create document for ${name}:`, error);
                    }
                }
            }
        }
        
        function setupFrotaTab() {
            onSnapshot(collection(db, "fleet"), (snapshot) => {
                snapshot.docs.forEach(doc => {
                    fleetData[doc.id] = { id: doc.id, ...doc.data() };
                });
                renderFleetCards();
            });
        }

        function renderFleetCards() {
            const grid = document.getElementById('fleet-grid');
            grid.innerHTML = '';
            const vehicleNames = ["Strada", "Montana", "Fiorino"];

            vehicleNames.forEach(name => {
                const vehicle = fleetData[name];
                const card = document.createElement('div');
                card.className = 'fleet-card bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex flex-col items-center justify-center gap-3 cursor-pointer';
                
                const pendingCount = vehicle?.pendingMaintenance?.length || 0;

                card.innerHTML = `
                    <i class="fa-solid fa-truck text-5xl text-blue-500"></i>
                    <h3 class="text-2xl font-bold">${name}</h3>
                    <div class="text-center">
                        <p class="text-lg font-semibold ${pendingCount > 0 ? 'text-red-500' : 'text-green-500'}">${pendingCount}</p>
                        <p class="text-sm text-gray-500">Manutenções Pendentes</p>
                    </div>
                `;
                card.addEventListener('click', () => openFleetModal(name));
                grid.appendChild(card);
            });
        }

        function openFleetModal(vehicleId) {
            const vehicle = fleetData[vehicleId] || { pendingMaintenance: [], history: [] };
            const sortedHistory = (vehicle.history || []).sort((a,b) => (b.completedAt?.seconds || 0) - (a.completedAt?.seconds || 0));

            let modalHTML = `
                <div class="flex justify-between items-start">
                    <h2 class="text-3xl font-bold mb-4">${vehicleId}</h2>
                    <button id="modal-close-btn" class="text-2xl">&times;</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div>
                        <h3 class="font-semibold text-xl mb-3 border-b pb-2">Manutenções Pendentes</h3>
                        <div id="pending-list" class="space-y-2">${renderTaskList(vehicle.pendingMaintenance, vehicleId, true)}</div>
                        <button id="add-task-btn" class="mt-4 w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Adicionar Tarefa</button>
                    </div>
                    <div>
                        <h3 class="font-semibold text-xl mb-3 border-b pb-2">Histórico</h3>
                        <div id="history-list" class="space-y-2">${renderTaskList(sortedHistory, vehicleId, false)}</div>
                    </div>
                </div>
            `;
            openModal(modalHTML);
            document.getElementById('modal-close-btn').onclick = closeModal;
            attachTaskListeners(vehicleId);
        }
        
        function renderTaskList(tasks, vehicleId, isPending) {
            if (!tasks || tasks.length === 0) return `<p class="text-sm text-gray-500">Nenhuma tarefa aqui.</p>`;
            return tasks.map(task => `
                <div class="flex items-center gap-3 bg-gray-100 dark:bg-gray-700 p-2 rounded-lg">
                     ${isPending ? `<button class="complete-task-btn text-green-500 hover:text-green-400" data-task-id="${task.id}"><i class="fa-solid fa-check-circle"></i></button>` : '<i class="fa-solid fa-check-circle text-green-500"></i>'}
                    <div class="flex-grow">
                         <p class="${!isPending ? 'task-completed' : ''}">${task.description}</p>
                         <div class="text-xs text-gray-400 flex gap-4">
                            ${task.createdAt ? `<span>Criado: ${new Date(task.createdAt).toLocaleDateString()}</span>` : ''}
                            ${!isPending && task.completedAt?.toDate ? `<span>Concluído: ${task.completedAt.toDate().toLocaleDateString()}</span>` : ''}
                         </div>
                    </div>
                    <button class="edit-task-btn" data-task-id="${task.id}" data-is-pending="${isPending}"><i class="fa-solid fa-pencil text-gray-500 hover:text-blue-500"></i></button>
                    <button class="delete-task-btn" data-task-id="${task.id}" data-is-pending="${isPending}"><i class="fa-solid fa-trash text-gray-500 hover:text-red-500"></i></button>
                </div>
            `).join('');
        }

        function attachTaskListeners(vehicleId) {
            document.getElementById('add-task-btn')?.addEventListener('click', () => openTaskEditModal(vehicleId));
            document.querySelectorAll('.edit-task-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const taskId = e.currentTarget.dataset.taskId;
                const isPending = e.currentTarget.dataset.isPending === 'true';
                const taskList = isPending ? fleetData[vehicleId].pendingMaintenance : fleetData[vehicleId].history;
                const task = taskList.find(t => t.id === taskId);
                openTaskEditModal(vehicleId, task, isPending);
            }));
            document.querySelectorAll('.delete-task-btn').forEach(btn => btn.addEventListener('click', (e) => {
                 const taskId = e.currentTarget.dataset.taskId;
                 const isPending = e.currentTarget.dataset.isPending === 'true';
                 openConfirmationModal("Tem a certeza que quer apagar esta tarefa?", () => deleteTask(vehicleId, taskId, isPending));
            }));
            document.querySelectorAll('.complete-task-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const taskId = e.currentTarget.dataset.taskId;
                openConfirmationModal("Marcar esta tarefa como concluída?", () => completeTask(vehicleId, taskId));
            }));
        }

        function openTaskEditModal(vehicleId, task = {}, isPending = true) {
            const isEditing = !!task.id;
            const today = new Date().toISOString().split('T')[0];
            const modalHTML = `
                <h3 class="text-lg font-bold mb-4">${isEditing ? 'Editar Tarefa' : 'Nova Tarefa'}</h3>
                <form id="task-form" class="space-y-4">
                    <div>
                        <label for="task-desc" class="block text-sm font-medium">Descrição</label>
                        <textarea id="task-desc" name="task-desc" class="w-full p-2 border rounded dark:bg-gray-700" required>${task.description || ''}</textarea>
                    </div>
                    <div>
                        <label for="createdAt" class="block text-sm font-medium">Data de Criação</label>
                        <input type="date" id="createdAt" name="createdAt" class="w-full p-2 border rounded dark:bg-gray-700" value="${task.createdAt || today}" ${isEditing ? 'readonly' : ''}>
                    </div>
                    <div class="mt-4 flex justify-end gap-3">
                        <button type="button" id="modal-cancel-task-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Salvar</button>
                    </div>
                </form>
            `;
            openModal(modalHTML);
            document.getElementById('modal-cancel-task-btn').onclick = () => openFleetModal(vehicleId);
            document.getElementById('task-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const description = e.target['task-desc'].value;
                const createdAt = e.target['createdAt'].value;
                saveTask(vehicleId, { ...task, description, createdAt }, isEditing, isPending);
            });
        }
        
        async function saveTask(vehicleId, task, isEditing, isPending) {
            const vehicleRef = doc(db, "fleet", vehicleId);
            if (isEditing) {
                const listName = isPending ? 'pendingMaintenance' : 'history';
                const list = [...fleetData[vehicleId][listName]];
                const taskIndex = list.findIndex(t => t.id === task.id);
                if (taskIndex > -1) list[taskIndex] = task;
                await updateDoc(vehicleRef, { [listName]: list });
            } else {
                task.id = crypto.randomUUID();
                await updateDoc(vehicleRef, { pendingMaintenance: arrayUnion(task) });
            }
            openFleetModal(vehicleId); // Refresh modal
        }

        async function deleteTask(vehicleId, taskId, isPending) {
            const vehicleRef = doc(db, "fleet", vehicleId);
            const listName = isPending ? 'pendingMaintenance' : 'history';
            const taskToDelete = fleetData[vehicleId][listName].find(t => t.id === taskId);
            await updateDoc(vehicleRef, { [listName]: arrayRemove(taskToDelete) });
            openFleetModal(vehicleId);
        }
        
        async function completeTask(vehicleId, taskId) {
            const vehicleRef = doc(db, "fleet", vehicleId);
            await runTransaction(db, async (transaction) => {
                const vehicleDoc = await transaction.get(vehicleRef);
                if (!vehicleDoc.exists()) throw "Document does not exist!";
                
                const data = vehicleDoc.data();
                const pendingList = data.pendingMaintenance || [];
                const historyList = data.history || [];
                
                const taskIndex = pendingList.findIndex(t => t.id === taskId);
                if (taskIndex === -1) return;

                const [taskToMove] = pendingList.splice(taskIndex, 1);
                
                const completedTask = { ...taskToMove, completedAt: new Date() };
                historyList.unshift(completedTask);

                transaction.update(vehicleRef, {
                    pendingMaintenance: pendingList,
                    history: historyList
                });
            });
            openFleetModal(vehicleId);
        }

    </script>
</body>
</html>

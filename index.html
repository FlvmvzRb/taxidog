<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetBoard - Sistema de Gestão</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Estilos Customizados -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fleet-card { transition: transform 0.2s, box-shadow 0.2s; }
        .fleet-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .manual-kanban-column { min-height: 400px; }
        .manual-pet-card { cursor: grab; }
        .manual-pet-card:active { cursor: grabbing; }

        /* Estilo para o "fantasma" do card sendo arrastado */
        .sortable-ghost {
            opacity: 0.4;
            background: #c8ebfb;
        }

        /* Estilo para tarefa concluída */
        .task-completed { text-decoration: line-through; color: #6b7280; } /* gray-500 */
        
        /* Modos de Agrupamento e Edição */
        .selection-mode .ungrouped-manual-pet-card { cursor: pointer; opacity: 0.6; }
        .selection-mode .ungrouped-manual-pet-card:hover { opacity: 1; border-color: #3b82f6; }
        .selection-mode .selected-for-grouping { border: 2px solid #3b82f6; box-shadow: 0 0 0 2px #3b82f6; opacity: 1; }
        
        .add-to-group-btn, .remove-from-group-btn { display: none; }
        .edit-mode-active .ungrouped-manual-pet-card .add-to-group-btn { display: inline-flex !important; cursor: pointer; }
        .edit-mode-active .editing-this-group .manual-group-pet .remove-from-group-btn { display: inline-flex !important; cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- TELA DE LOGIN -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <div class="text-center">
                <i class="fa-solid fa-paw text-4xl text-blue-600"></i>
                <h1 class="text-3xl font-bold mt-2">PetBoard</h1>
                <p class="text-gray-500 dark:text-gray-400">Acesse para gerenciar as rotas</p>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700" placeholder="seu@email.com">
                <input type="password" id="password" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700" placeholder="Sua senha">
                <button type="submit" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">Entrar</button>
            </form>
            <p id="login-error" class="text-red-500 text-sm text-center h-4 mt-4"></p>
        </div>
    </div>

    <!-- APLICAÇÃO PRINCIPAL -->
    <div id="app-view" class="hidden">
        <header class="fixed top-0 left-0 w-full bg-white dark:bg-gray-800 shadow-md z-40">
             <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                 <div class="flex items-center gap-4">
                     <h1 class="text-2xl font-bold text-blue-600"><i class="fa-solid fa-paw"></i> PetBoard</h1>
                     <nav class="hidden md:flex items-center gap-2">
                         <button data-tab="manual_painel" class="nav-tab active-tab px-3 py-1 rounded-lg font-semibold bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300"><i class="fa-solid fa-pen-ruler mr-2"></i>Painel Manual</button>
                         <button data-tab="frota" class="nav-tab px-3 py-1 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fa-solid fa-truck mr-2"></i>Frota</button>
                         <button data-tab="enderecos" class="nav-tab px-3 py-1 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fa-solid fa-map-location-dot mr-2"></i>Endereços</button>
                         <button data-tab="config" class="nav-tab px-3 py-1 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fa-solid fa-gear mr-2"></i>Configurações</button>
                     </nav>
                 </div>
                 <div class="flex items-center gap-4">
                     <span id="user-email" class="text-sm"></span>
                     <button id="logout-btn" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg text-sm"><i class="fa-solid fa-right-from-bracket"></i></button>
                 </div>
             </div>
             <div class="md:hidden border-t dark:border-gray-700">
                 <nav class="flex justify-around items-center p-1">
                     <button data-tab="manual_painel" class="nav-tab active-tab flex-1 text-center py-2 rounded-lg font-semibold bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300" title="Painel Manual"><i class="fa-solid fa-pen-ruler"></i></button>
                     <button data-tab="frota" class="nav-tab flex-1 text-center py-2 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-700" title="Frota"><i class="fa-solid fa-truck"></i></button>
                     <button data-tab="enderecos" class="nav-tab flex-1 text-center py-2 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-700" title="Endereços"><i class="fa-solid fa-map-location-dot"></i></button>
                     <button data-tab="config" class="nav-tab flex-1 text-center py-2 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-700" title="Configurações"><i class="fa-solid fa-gear"></i></button>
                 </nav>
             </div>
        </header>

        <main class="pt-28 md:pt-20">
            <!-- ABA PAINEL MANUAL -->
            <div id="manual_painel-tab" class="tab-content p-2 md:p-4">
                <div class="mb-4 flex flex-wrap items-center gap-4">
                     <input type="date" id="manual-painel-date-filter" class="bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-lg px-3 py-1.5">
                     <select id="manual-painel-route-filter" class="bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-lg px-3 py-1.5 flex-grow">
                         <option value="all">Todas as Rotas Manuais</option>
                    </select>
                    <button id="import-csv-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-3 py-1.5 rounded-lg"><i class="fa-solid fa-file-csv mr-2"></i>Importar Planilha (CSV)</button>
                    <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                </div>
                <div id="manual-kanban-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
            </div>

            <!-- ABA FROTA -->
            <div id="frota-tab" class="tab-content hidden p-2 md:p-4">
                 <div id="fleet-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            </div>

            <!-- ABA ENDEREÇOS -->
            <div id="enderecos-tab" class="tab-content hidden p-2 md:p-4">
                <div class="mb-4 flex flex-wrap items-center gap-4">
                    <div class="relative flex-grow">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i class="fa-solid fa-search text-gray-400"></i>
                        </span>
                        <input type="text" id="address-search-input" placeholder="Pesquisar por pet, tutor, endereço ou CEP..." class="w-full bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-lg pl-10 pr-4 py-1.5">
                    </div>
                    <button id="add-address-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-1.5 rounded-lg"><i class="fa-solid fa-plus mr-2"></i>Adicionar Endereço</button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="px-6 py-3">Pet</th>
                                <th scope="col" class="px-6 py-3">Tutor</th>
                                <th scope="col" class="px-6 py-3">Endereço</th>
                                <th scope="col" class="px-6 py-3">CEP</th>
                                <th scope="col" class="px-6 py-3">Observações</th>
                                <th scope="col" class="px-6 py-3"><span class="sr-only">Ações</span></th>
                            </tr>
                        </thead>
                        <tbody id="addresses-table-body">
                            <!-- Linhas de endereço serão inseridas aqui via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ABA CONFIGURAÇÕES -->
            <div id="config-tab" class="tab-content hidden p-2 md:p-4">
                <div class="max-w-2xl mx-auto space-y-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Gerenciar Rotas Manuais</h2>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                            <form id="add-manual-route-def-form" class="flex gap-2 mb-6">
                                <input type="text" id="add-manual-route-def-input" placeholder="Nome da nova rota" required class="flex-grow bg-gray-100 dark:bg-gray-700 border dark:border-gray-600 rounded-lg px-3 py-1.5">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-1.5 rounded-lg">Adicionar</button>
                            </form>
                            <h3 class="font-semibold mb-2">Rotas existentes:</h3>
                            <div id="manual-routes-list" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div id="generic-modal-content" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-lg m-4 transform transition-all overflow-y-auto max-h-[90vh]"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, getDoc, runTransaction, updateDoc, arrayUnion, arrayRemove, serverTimestamp, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURAÇÃO E INICIALIZAÇÃO ---
        const firebaseConfig = {
            apiKey: "AIzaSyCKOXqvwo9wA7pMDdoLMMtUiQSKDW9bygU",
            authDomain: "taxidog-593d8.firebaseapp.com",
            projectId: "taxidog-593d8",
            storageBucket: "taxidog-593d8.appspot.com",
            messagingSenderId: "419627111718",
            appId: "1:419627111718:web:805c187a118d199aa9dde7"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GESTÃO DE ESTADO CENTRALIZADO ---
        const AppState = {
            fleet: {},
            addresses: [],
            config: { 
                manualRoutes: [],
            },
            schedules: {
                manual: null,
            },
            ui: {
                selectedForGrouping: [],
            }
        };

        // --- REFERÊNCIAS DO DOM ---
        const loginView = document.getElementById('login-view'), appView = document.getElementById('app-view'),
              loginForm = document.getElementById('login-form'), loginError = document.getElementById('login-error'),
              userEmailSpan = document.getElementById('user-email'), logoutBtn = document.getElementById('logout-btn');

        // --- LÓGICA DE AUTENTICAÇÃO ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginView.classList.add('hidden');
                appView.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                initializeAppLogic(user); 
            } else {
                appView.classList.add('hidden');
                loginView.classList.remove('hidden');
                userEmailSpan.textContent = '';
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                        createUserWithEmailAndPassword(auth, email, password)
                           .catch(err => { loginError.textContent = 'Erro ao criar conta: ' + err.message; });
                    } else { loginError.textContent = 'Email ou senha incorretos.'; }
                });
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- LÓGICA PRINCIPAL ---
        async function initializeAppLogic(user) {
            await ensureFleetDataExists();
            setupNavigation();
            setupFrotaTab();
            setupEnderecosTab();
            setupConfigTab(); 
            setupManualPainelTab();
        }

        // --- NAVEGAÇÃO ---
        function setupNavigation() {
            const navTabs = document.querySelectorAll('.nav-tab'), tabContents = document.querySelectorAll('.tab-content');
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    navTabs.forEach(t => t.classList.remove('active-tab', 'bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300'));
                    document.querySelectorAll(`.nav-tab[data-tab="${tabName}"]`).forEach(t => t.classList.add('active-tab', 'bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300'));
                    tabContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(`${tabName}-tab`).classList.remove('hidden');
                    if (tabName === 'manual_painel') loadManualScheduleForDate();
                });
            });
        }
        
        // --- MODAIS ---
        const modal = document.getElementById('generic-modal'), modalContent = document.getElementById('generic-modal-content');
        function openModal(html) { modalContent.innerHTML = html; modal.classList.remove('hidden'); }
        function closeModal() { modal.classList.add('hidden'); modalContent.innerHTML = ''; }
        modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

        function openInfoModal(message, title = "Aviso") {
            const modalHTML = `
                <h3 class="text-lg font-bold mb-4">${title}</h3>
                <p>${message}</p>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="ok-info-btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white">OK</button>
                </div>
            `;
            openModal(modalHTML);
            document.getElementById('ok-info-btn').onclick = closeModal;
        }

        function openConfirmationModal(message, onConfirm) {
            const modalHTML = `
                <h3 class="text-lg font-bold mb-4">Confirmação</h3>
                <p>${message}</p>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-confirm-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Cancelar</button>
                    <button id="do-confirm-btn" class="px-4 py-2 rounded-lg bg-green-600 text-white">Confirmar</button>
                </div>
            `;
            openModal(modalHTML);
            document.getElementById('do-confirm-btn').onclick = () => { onConfirm(); closeModal(); };
            document.getElementById('cancel-confirm-btn').onclick = closeModal;
        }
        
        // --- ABA CONFIGURAÇÕES ---
        function setupConfigTab() {
            const configRef = doc(db, 'settings', 'app_config');
            onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    AppState.config = {...AppState.config, ...data};
                } else {
                    setDoc(configRef, { 
                        manualRoutes: ["Rota 1", "Rota 2", "Rota 3", "Avulso"],
                    });
                }
                renderManualRoutesList();
                populateManualRouteFilter();
            });

            const manualRouteForm = document.getElementById('add-manual-route-def-form');
            manualRouteForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('add-manual-route-def-input');
                const routeName = input.value.trim();
                const button = e.target.querySelector('button[type="submit"]');

                if (routeName && !(AppState.config.manualRoutes || []).includes(routeName)) {
                    button.disabled = true;
                    button.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
                    try {
                        const updatedRoutes = [...(AppState.config.manualRoutes || []), routeName];
                        await updateDoc(configRef, { manualRoutes: updatedRoutes });
                        input.value = '';
                    } catch (error) {
                        console.error("Erro ao adicionar rota:", error);
                        openInfoModal("Não foi possível adicionar a rota. Tente novamente.", "Erro");
                    } finally {
                        button.disabled = false;
                        button.textContent = 'Adicionar';
                    }
                } else {
                    openInfoModal("Esta rota já existe ou o nome é inválido.");
                }
            });
        }

        function renderManualRoutesList() {
            const listContainer = document.getElementById('manual-routes-list');
            listContainer.innerHTML = '';
            const routes = AppState.config.manualRoutes || [];
            if (routes.length > 0) {
                routes.forEach(routeName => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                    div.innerHTML = `
                        <span>${routeName}</span>
                        <div class="flex gap-3">
                            <button class="edit-manual-route-def-btn text-blue-500 hover:text-blue-400" data-route-name="${routeName}"><i class="fa-solid fa-pencil"></i></button>
                            <button class="delete-manual-route-def-btn text-red-500 hover:text-red-400" data-route-name="${routeName}"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });

                document.querySelectorAll('.delete-manual-route-def-btn').forEach(btn => {
                    btn.onclick = () => {
                        const routeNameToDelete = btn.dataset.routeName;
                        openConfirmationModal(`Tem certeza que quer apagar a definição da rota "${routeNameToDelete}"?`, () => {
                            const updatedRoutes = AppState.config.manualRoutes.filter(r => r !== routeNameToDelete);
                            updateDoc(doc(db, 'settings', 'app_config'), { manualRoutes: updatedRoutes });
                        });
                    };
                });

                document.querySelectorAll('.edit-manual-route-def-btn').forEach(btn => {
                    btn.onclick = () => {
                        const oldRouteName = btn.dataset.routeName;
                        openEditManualRouteModal(oldRouteName);
                    };
                });

            } else {
                listContainer.innerHTML = `<p class="text-gray-500 text-sm">Nenhuma rota manual definida.</p>`;
            }
        }
        
        function openEditManualRouteModal(oldName) {
            const modalHTML = `
                <h3 class="text-lg font-bold mb-4">Editar Nome da Rota</h3>
                <form id="edit-route-form">
                    <input name="new-route-name" class="w-full p-2 border rounded dark:bg-gray-700" required value="${oldName}">
                    <div class="mt-4 flex justify-end gap-2">
                         <button type="button" id="modal-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Salvar</button>
                    </div>
                </form>
            `;
            openModal(modalHTML);
            document.getElementById('modal-cancel-btn').onclick = closeModal;
            document.getElementById('edit-route-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = e.target['new-route-name'].value.trim();
                const button = e.target.querySelector('button[type="submit"]');
                button.disabled = true;
                button.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Salvando...`;
                
                try {
                    await saveManualRouteEdit(oldName, newName);
                    closeModal();
                } catch (error) {
                    console.error("Erro ao salvar edição da rota:", error);
                    openInfoModal(error.message, "Erro");
                } finally {
                     button.disabled = false;
                     button.textContent = 'Salvar';
                }
            });
        }

        async function saveManualRouteEdit(oldName, newName) {
            if (!newName) {
                throw new Error("O nome da rota não pode estar vazio.");
            }
            if (oldName === newName) {
                return; // Nenhuma alteração necessária
            }
            if (AppState.config.manualRoutes.includes(newName)) {
                throw new Error(`A rota "${newName}" já existe.`);
            }

            const configRef = doc(db, 'settings', 'app_config');
            const newRoutesList = AppState.config.manualRoutes.map(r => r === oldName ? newName : r);
            await updateDoc(configRef, { manualRoutes: newRoutesList });

            const schedulesSnapshot = await getDocs(collection(db, "manual_schedules"));
            for (const scheduleDoc of schedulesSnapshot.docs) {
                const scheduleData = scheduleDoc.data();
                if (scheduleData.routes && scheduleData.routes[oldName]) {
                    const updatedRoutes = { ...scheduleData.routes };
                    updatedRoutes[newName] = updatedRoutes[oldName];
                    delete updatedRoutes[oldName];
                    await updateDoc(doc(db, "manual_schedules", scheduleDoc.id), { routes: updatedRoutes });
                }
            }
        }

        // --- ABA PAINEL MANUAL ---
        function setupManualPainelTab() {
            const dateFilter = document.getElementById('manual-painel-date-filter');
            dateFilter.valueAsDate = new Date();
            dateFilter.addEventListener('change', loadManualScheduleForDate);

            const routeFilter = document.getElementById('manual-painel-route-filter');
            routeFilter.addEventListener('change', renderManualKanbanBoard);
            
            document.getElementById('import-csv-btn').addEventListener('click', () => {
                document.getElementById('csv-file-input').click();
            });
            document.getElementById('csv-file-input').addEventListener('change', handleCsvFile);

            loadManualScheduleForDate();
        }

        function populateManualRouteFilter() {
            const routeFilter = document.getElementById('manual-painel-route-filter');
            const currentVal = routeFilter.value;
            routeFilter.innerHTML = '<option value="all">Todas as Rotas Manuais</option>';
            if(AppState.config.manualRoutes) {
                AppState.config.manualRoutes.forEach(routeName => {
                    routeFilter.innerHTML += `<option value="${routeName}">${routeName}</option>`;
                });
            }
            routeFilter.value = currentVal;
        }

        async function loadManualScheduleForDate() {
            const dateStr = document.getElementById('manual-painel-date-filter').value;
            if (!dateStr) {
                document.getElementById('manual-kanban-board').innerHTML = '';
                return;
            }
            const scheduleRef = doc(db, "manual_schedules", dateStr);
            await setDoc(scheduleRef, {}, { merge: true });

            onSnapshot(scheduleRef, (docSnap) => {
                AppState.schedules.manual = docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
                renderManualKanbanBoard();
            });
        }
        
        function renderManualKanbanBoard() {
            const board = document.getElementById('manual-kanban-board');
            board.innerHTML = '';
            const selectedRoute = document.getElementById('manual-painel-route-filter').value;
            
            const routesToDisplay = selectedRoute === 'all' 
                ? (AppState.config.manualRoutes || [])
                : [selectedRoute];

            if (!routesToDisplay || routesToDisplay.length === 0) {
                 board.innerHTML = `<p class="col-span-full text-center text-gray-500 mt-8">Nenhuma rota manual definida. Vá para a aba de Configurações para criar uma.</p>`;
                 return;
            }

            routesToDisplay.forEach(routeName => {
                const routeData = AppState.schedules.manual?.routes?.[routeName] || { pets: [], groups: [], observations: [] };
                const column = document.createElement('div');
                column.className = 'manual-kanban-column bg-gray-200 dark:bg-gray-800 rounded-lg p-3 flex flex-col gap-3';
                column.dataset.routeName = routeName;
                
                column.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg">${routeName}</h3>
                        <div class="flex items-center gap-2">
                             <button class="add-manual-obs-btn text-sm py-1 px-2 rounded bg-yellow-500 text-white" data-route-name="${routeName}">OBS</button>
                            <button class="manual-group-btn text-sm py-1 px-2 rounded bg-blue-500 text-white" data-route-name="${routeName}">Agrupar</button>
                            <button class="add-manual-pet-btn text-green-600 hover:text-green-500" data-route-name="${routeName}"><i class="fa-solid fa-plus-circle text-xl"></i></button>
                        </div>
                    </div>
                    <div class="manual-obs-container space-y-1 text-xs"></div>
                    <div class="manual-pets-container space-y-3 flex-grow"></div>
                `;
                board.appendChild(column);

                const obsContainer = column.querySelector('.manual-obs-container');
                (routeData.observations || []).forEach(obs => {
                    const obsEl = document.createElement('div');
                    obsEl.className = 'bg-yellow-100 dark:bg-yellow-900 p-1.5 rounded-md flex justify-between items-center';
                    obsEl.innerHTML = `<span>${obs.text}</span> <i class="fa-solid fa-trash-can cursor-pointer text-red-500 hover:text-red-700" data-obs-id="${obs.id}"></i>`;
                    obsEl.querySelector('i').onclick = () => deleteManualObservation(routeName, obs.id);
                    obsContainer.appendChild(obsEl);
                });

                const petsContainer = column.querySelector('.manual-pets-container');
                const allPetsInRoute = routeData.pets || [];
                
                let allGroupsInRoute = routeData.groups || [];
                if (allGroupsInRoute && !Array.isArray(allGroupsInRoute) && typeof allGroupsInRoute === 'object') {
                    allGroupsInRoute = Object.entries(allGroupsInRoute).map(([id, data]) => ({ id, ...data }));
                }

                allGroupsInRoute.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

                allGroupsInRoute.forEach(group => {
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'group-container p-2 rounded-lg bg-gray-300 dark:bg-gray-900';
                    groupContainer.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold">${group.name}</h4>
                            <div class="flex gap-2">
                                <button class="edit-manual-group-btn text-xs" data-group-id="${group.id}" data-route-name="${routeName}"><i class="fa-solid fa-pencil"></i></button>
                                <button class="ungroup-manual-btn text-xs" data-group-id="${group.id}" data-route-name="${routeName}"><i class="fa-solid fa-sign-out-alt"></i></button>
                            </div>
                        </div>
                        <div class="manual-group-pets-container space-y-2" data-group-id="${group.id}"></div>
                    `;
                    petsContainer.appendChild(groupContainer);
                    const groupPetsContainer = groupContainer.querySelector('.manual-group-pets-container');
                    allPetsInRoute.filter(p => p.groupId === group.id).forEach(p => groupPetsContainer.appendChild(createManualKanbanPetCard(p, routeName, true)));
                });

                const ungroupedContainer = document.createElement('div');
                ungroupedContainer.className = 'ungrouped-pets-container space-y-2 mt-3';
                petsContainer.appendChild(ungroupedContainer);
                allPetsInRoute.filter(p => !p.groupId).forEach(p => ungroupedContainer.appendChild(createManualKanbanPetCard(p, routeName, false)));
            });

            document.querySelectorAll('.add-manual-pet-btn').forEach(btn => btn.onclick = () => openAddManualPetModal(btn.dataset.routeName));
            document.querySelectorAll('.add-manual-obs-btn').forEach(btn => btn.onclick = () => openManualObservationModal(btn.dataset.routeName));
            document.querySelectorAll('.manual-group-btn').forEach(btn => btn.onclick = (e) => toggleManualGroupingMode(e.currentTarget.dataset.routeName, e.currentTarget));
            document.querySelectorAll('.edit-manual-group-btn').forEach(btn => btn.onclick = (e) => toggleEditManualGroupMode(e.currentTarget.dataset.routeName, e.currentTarget.dataset.groupId, e.currentTarget));
            document.querySelectorAll('.ungroup-manual-btn').forEach(btn => btn.onclick = (e) => unGroupManual(e.currentTarget.dataset.routeName, e.currentTarget.dataset.groupId));
            
            const petContainers = board.querySelectorAll('.ungrouped-pets-container, .manual-group-pets-container');
            petContainers.forEach(container => {
                new Sortable(container, {
                    group: 'manual-kanban',
                    animation: 150,
                    onEnd: handlePetMove
                });
            });
        }

        function createManualKanbanPetCard(pet, routeName, isGrouped) {
            const card = document.createElement('div');
            card.className = `bg-white dark:bg-gray-700 p-2 rounded-md shadow flex justify-between items-center manual-pet-card ${isGrouped ? 'manual-group-pet' : 'ungrouped-manual-pet-card'}`;
            card.dataset.petId = pet.id;

            card.innerHTML = `
                <span class="font-semibold">${pet.name}</span>
                <div class="flex items-center gap-2">
                    <button class="add-to-group-btn text-green-500" data-pet-id="${pet.id}"><i class="fa-solid fa-plus-circle"></i></button>
                    <button class="remove-from-group-btn text-red-500" data-pet-id="${pet.id}"><i class="fa-solid fa-minus-circle"></i></button>
                    <button class="edit-manual-pet-btn text-blue-500 hover:text-blue-400" data-route-name="${routeName}"><i class="fa-solid fa-pencil"></i></button>
                    <button class="delete-manual-pet-btn text-red-500 hover:text-red-400" data-route-name="${routeName}"><i class="fa-solid fa-times"></i></button>
                </div>
            `;
            
            card.querySelector('.delete-manual-pet-btn').onclick = (e) => {
                e.stopPropagation();
                deleteManualPet(routeName, pet.id);
            };

            card.querySelector('.edit-manual-pet-btn').onclick = (e) => {
                e.stopPropagation();
                openEditManualPetModal(pet, routeName);
            };
            
            return card;
        }

        function openEditManualPetModal(pet, routeName) {
            const modalHTML = `
                <h3 class="text-lg font-bold mb-4">Editar Nome do Pet</h3>
                <form id="edit-manual-pet-form">
                    <input name="new-pet-name" class="w-full p-2 border rounded dark:bg-gray-700" required value="${pet.name}">
                    <div class="mt-4 flex justify-end gap-2">
                         <button type="button" id="modal-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Salvar</button>
                    </div>
                </form>
            `;
            openModal(modalHTML);
            document.getElementById('modal-cancel-btn').onclick = closeModal;
            document.getElementById('edit-manual-pet-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = e.target['new-pet-name'].value.trim();
                if (newName) {
                    await saveManualPetEdit(routeName, pet, newName);
                }
                closeModal();
            });
        }

        async function saveManualPetEdit(routeName, petToEdit, newName) {
            const dateStr = document.getElementById('manual-painel-date-filter').value;
            const routeData = AppState.schedules.manual?.routes?.[routeName];
            if (!routeData) return;

            const updatedPets = routeData.pets.map(p => {
                if (p.id === petToEdit.id) {
                    return { ...p, name: newName };
                }
                return p;
            });

            const updatePath = `routes.${routeName}.pets`;
            await updateManualSchedule(dateStr, { [updatePath]: updatedPets });
        }
        
        function openAddManualPetModal(routeName) {
            const modalHTML = `
                <h3 class="text-lg font-bold mb-4">Adicionar Pet à Rota "${routeName}"</h3>
                <form id="manual-pet-form">
                    <input name="pet-name" class="w-full p-2 border rounded dark:bg-gray-700" placeholder="Digite o nome do pet" required>
                    <div class="mt-4 flex justify-end gap-2">
                         <button type="button" id="modal-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Adicionar</button>
                    </div>
                </form>
            `;
            openModal(modalHTML);
            document.getElementById('modal-cancel-btn').onclick = closeModal;
            document.getElementById('manual-pet-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const petName = e.target['pet-name'].value.trim();
                if(petName) addManualPet(routeName, petName);
                closeModal();
            });
        }
        
        async function updateManualSchedule(dateStr, updateData) {
            const scheduleRef = doc(db, "manual_schedules", dateStr);
            await setDoc(scheduleRef, {}, { merge: true });
            await updateDoc(scheduleRef, updateData);
        }
        
        async function addManualPet(routeName, petName) {
            const dateStr = document.getElementById('manual-painel-date-filter').value;
            const newPet = { id: crypto.randomUUID(), name: petName };
            const updatePath = `routes.${routeName}.pets`;
            await updateManualSchedule(dateStr, { [updatePath]: arrayUnion(newPet) });
        }

        async function deleteManualPet(routeName, petId) {
            const dateStr = document.getElementById('manual-painel-date-filter').value;
            const routeData = AppState.schedules.manual?.routes?.[routeName];
            if (!routeData) return;

            const petToDelete = routeData.pets.find(p => p.id === petId);
            if (petToDelete) {
                const updatePath = `routes.${routeName}.pets`;
                await updateManualSchedule(dateStr, { [updatePath]: arrayRemove(petToDelete) });
            }
        }

        async function handlePetMove(evt) {
            const itemEl = evt.item;
            const toList = evt.to;
            const fromList = evt.from;
            const newIndex = evt.newDraggableIndex;

            const petId = itemEl.dataset.petId;
            const toRouteName = toList.closest('.manual-kanban-column').dataset.routeName;
            const fromRouteName = fromList.closest('.manual-kanban-column').dataset.routeName;
            
            const dateStr = document.getElementById('manual-painel-date-filter').value;
            const scheduleData = AppState.schedules.manual;

            const petToMove = scheduleData.routes[fromRouteName]?.pets.find(p => p.id === petId);
            if (!petToMove) {
                console.error("Could not find pet to move in AppState. Re-rendering.");
                renderManualKanbanBoard(); 
                return;
            }

            const updatePayload = {};
            const fromPets = scheduleData.routes[fromRouteName].pets.filter(p => p.id !== petId);

            let toPets;
            if (fromRouteName === toRouteName) {
                toPets = [...fromPets];
            } else {
                toPets = [...(scheduleData.routes[toRouteName]?.pets || [])];
            }
            
            const movedPetData = { ...petToMove };
            if (toList.classList.contains('ungrouped-pets-container')) {
                delete movedPetData.groupId;
            } else {
                const newGroupId = toList.dataset.groupId;
                if (newGroupId) {
                    movedPetData.groupId = newGroupId;
                }
            }
            
            toPets.splice(newIndex, 0, movedPetData);

            if (fromRouteName === toRouteName) {
                updatePayload[`routes.${toRouteName}.pets`] = toPets;
            } else {
                updatePayload[`routes.${fromRouteName}.pets`] = fromPets;
                updatePayload[`routes.${toRouteName}.pets`] = toPets;
            }

            try {
                await updateManualSchedule(dateStr, updatePayload);
            } catch (error) {
                console.error("Error updating pet order/route:", error);
                openInfoModal("Ocorreu um erro ao salvar a nova ordem. A visualização será atualizada.", "Erro");
            }
        }

        // --- LÓGICA DE OBSERVAÇÕES MANUAIS ---
        function openManualObservationModal(routeName) {
            const modalHTML = `
                <h3 class="text-lg font-bold mb-4">Adicionar Observação para ${routeName}</h3>
                <form id="manual-obs-form">
                    <textarea name="obs-text" class="w-full p-2 border rounded dark:bg-gray-700" placeholder="Digite a observação..."></textarea>
                    <div class="mt-4 flex justify-end gap-2">
                         <button type="button" id="modal-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Salvar</button>
                    </div>
                </form>
            `;
            openModal(modalHTML);
            document.getElementById('modal-cancel-btn').onclick = closeModal;
            document.getElementById('manual-obs-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const text = e.target['obs-text'].value;
                if(text) saveManualObservation(routeName, text);
                closeModal();
            });
        }

        async function saveManualObservation(routeName, text) {
            const dateStr = document.getElementById('manual-painel-date-filter').value;
            const newObs = { id: crypto.randomUUID(), text: text };
            const updatePath = `routes.${routeName}.observations`;
            await updateManualSchedule(dateStr, { [updatePath]: arrayUnion(newObs) });
        }

        async function deleteManualObservation(routeName, obsId) {
            const dateStr = document.getElementById('manual-painel-date-filter').value;
            const routeData = AppState.schedules.manual?.routes?.[routeName];
            if (!routeData || !routeData.observations) return;

            const obsToDelete = routeData.observations.find(o => o.id === obsId);
            if (obsToDelete) {
                const updatePath = `routes.${routeName}.observations`;
                await updateManualSchedule(dateStr, { [updatePath]: arrayRemove(obsToDelete) });
            }
        }

        // --- LÓGICA DE AGRUPAMENTO MANUAL ---
        function toggleManualGroupingMode(routeName, btn) {
            const column = btn.closest('.manual-kanban-column');
            column.classList.toggle('selection-mode');
            if (column.classList.contains('selection-mode')) {
                btn.textContent = 'Criar Remessa';
                btn.onclick = () => createManualRemessa(routeName, btn);
                column.querySelectorAll('.ungrouped-manual-pet-card').forEach(card => {
                    card.onclick = () => {
                        card.classList.toggle('selected-for-grouping');
                        const petId = card.dataset.petId;
                        if (AppState.ui.selectedForGrouping.includes(petId)) {
                            AppState.ui.selectedForGrouping = AppState.ui.selectedForGrouping.filter(id => id !== petId);
                        } else {
                            AppState.ui.selectedForGrouping.push(petId);
                        }
                    };
                });
            } else {
                btn.textContent = 'Agrupar';
                AppState.ui.selectedForGrouping = [];
                column.querySelectorAll('.ungrouped-manual-pet-card').forEach(card => card.classList.remove('selected-for-grouping'));
                btn.onclick = () => toggleManualGroupingMode(routeName, btn);
            }
        }

        function createManualRemessa(routeName, btn) {
            if (AppState.ui.selectedForGrouping.length === 0) {
                openInfoModal('Selecione pelo menos um pet!');
                return;
            }
            const modalHTML = `<h3 class="text-lg font-bold mb-4">Nome da Remessa</h3><form id="group-form"><input name="group-name" class="w-full p-2 border rounded dark:bg-gray-700" placeholder="Ex: Manhã - Zona Sul"><div class="mt-4 flex justify-end"><button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Criar</button></div></form>`;
            openModal(modalHTML);
            document.getElementById('group-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const groupName = e.target['group-name'].value;
                if (!groupName) return;
                
                const groupId = crypto.randomUUID();
                const dateStr = document.getElementById('manual-painel-date-filter').value;
                
                const currentRouteData = AppState.schedules.manual?.routes?.[routeName] || { pets: [], groups: [] };
                const currentPets = currentRouteData.pets;
                
                const updatedPets = currentPets.map(pet => {
                    if (AppState.ui.selectedForGrouping.includes(pet.id)) {
                        return { ...pet, groupId: groupId };
                    }
                    return pet;
                });

                const newGroup = { id: groupId, name: groupName, createdAt: serverTimestamp() };
                const groupsPath = `routes.${routeName}.groups`;
                const petsPath = `routes.${routeName}.pets`;
                
                await updateManualSchedule(dateStr, {
                    [groupsPath]: arrayUnion(newGroup),
                    [petsPath]: updatedPets
                });

                AppState.ui.selectedForGrouping = [];
                const column = btn.closest('.manual-kanban-column');
                column.classList.remove('selection-mode');
                btn.textContent = 'Agrupar';
                btn.onclick = () => toggleManualGroupingMode(routeName, btn);
                column.querySelectorAll('.ungrouped-manual-pet-card').forEach(card => card.classList.remove('selected-for-grouping'));

                closeModal();
            });
        }

        async function unGroupManual(routeName, groupId) {
            const dateStr = document.getElementById('manual-painel-date-filter').value;
            const currentRouteData = AppState.schedules.manual?.routes?.[routeName];
            if (!currentRouteData) return;

            const updatedPets = currentRouteData.pets.map(p => {
                if (p.groupId === groupId) {
                    const { groupId, ...rest } = p;
                    return rest;
                }
                return p;
            });
            
            let groups = currentRouteData.groups || [];
            if (groups && !Array.isArray(groups) && typeof groups === 'object') {
                groups = Object.entries(groups).map(([id, data]) => ({ id, ...data }));
            }
            const groupToRemove = groups.find(g => g.id === groupId);

            const groupsPath = `routes.${routeName}.groups`;
            const petsPath = `routes.${routeName}.pets`;

            if (groupToRemove) {
                await updateManualSchedule(dateStr, {
                    [petsPath]: updatedPets,
                    [groupsPath]: arrayRemove(groupToRemove)
                });
            } else {
                 await updateManualSchedule(dateStr, { [petsPath]: updatedPets });
            }
        }

        function toggleEditManualGroupMode(routeName, groupId, btn) {
            const column = btn.closest('.manual-kanban-column');
            const groupContainer = btn.closest('.group-container');
            const isEditingNow = column.classList.contains('edit-mode-active');
            
            document.querySelectorAll('.edit-mode-active').forEach(c => c.classList.remove('edit-mode-active'));
            document.querySelectorAll('.editing-this-group').forEach(g => g.classList.remove('editing-this-group'));
            document.querySelectorAll('.edit-manual-group-btn').forEach(b => b.innerHTML = `<i class="fa-solid fa-pencil"></i>`);
            
            if (!isEditingNow || groupContainer.dataset.editingGroupId !== groupId) {
                column.classList.add('edit-mode-active');
                groupContainer.classList.add('editing-this-group');
                groupContainer.dataset.editingGroupId = groupId;
                btn.innerHTML = `<i class="fa-solid fa-check"></i>`;

                column.querySelectorAll('.ungrouped-manual-pet-card .add-to-group-btn').forEach(addBtn => {
                    addBtn.onclick = () => addPetToManualGroup(routeName, addBtn.dataset.petId, groupId);
                });
                groupContainer.querySelectorAll('.manual-group-pet .remove-from-group-btn').forEach(removeBtn => {
                    removeBtn.onclick = () => removePetFromManualGroup(routeName, removeBtn.dataset.petId);
                });
            }
        }

        async function addPetToManualGroup(routeName, petId, groupId) {
            const dateStr = document.getElementById('manual-painel-date-filter').value;
            const currentPets = AppState.schedules.manual?.routes?.[routeName]?.pets || [];
            const updatedPets = currentPets.map(p => p.id === petId ? { ...p, groupId: groupId } : p);
            const petsPath = `routes.${routeName}.pets`;
            await updateManualSchedule(dateStr, { [petsPath]: updatedPets });
        }

        async function removePetFromManualGroup(routeName, petId) {
            const dateStr = document.getElementById('manual-painel-date-filter').value;
            const currentPets = AppState.schedules.manual?.routes?.[routeName]?.pets || [];
            const updatedPets = currentPets.map(p => {
                if (p.id === petId) {
                    const { groupId, ...rest } = p;
                    return rest;
                }
                return p;
            });
            const petsPath = `routes.${routeName}.pets`;
            await updateManualSchedule(dateStr, { [petsPath]: updatedPets });
        }
        
        // --- LÓGICA DE IMPORTAÇÃO DE PLANILHA (CSV) ---
        async function handleCsvFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const importBtn = document.getElementById('import-csv-btn');
            importBtn.disabled = true;
            importBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Processando...`;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                try {
                    const rows = text.split('\n').filter(row => row.trim() !== '');
                    if (rows.length < 2) {
                        throw new Error("O ficheiro CSV está vazio ou não tem cabeçalho.");
                    }
                    
                    const headers = rows[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                    const petNameIndex = headers.indexOf('Nome do Pet');
                    const routeIndex = headers.indexOf('Rota Selecionada');

                    if (petNameIndex === -1 || routeIndex === -1) {
                        throw new Error("O ficheiro CSV deve conter as colunas 'Nome do Pet' e 'Rota Selecionada'.");
                    }

                    const petsToImport = [];
                    for (let i = 1; i < rows.length; i++) {
                        const values = rows[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                        const petName = values[petNameIndex];
                        const route = values[routeIndex];
                        if (petName && route) {
                            petsToImport.push({ name: petName, route: route });
                        }
                    }

                    if (petsToImport.length === 0) {
                        openInfoModal("Nenhum pet encontrado no ficheiro para importar.", "Aviso");
                        return;
                    }
                    
                    const dateStr = document.getElementById('manual-painel-date-filter').value;
                    const updatePayload = {};
                    const newRoutes = new Set();

                    petsToImport.forEach(pet => {
                        const routeName = pet.route;
                        if (!routeName) return;

                        if (!AppState.config.manualRoutes.includes(routeName)) {
                            newRoutes.add(routeName);
                        }

                        const updatePath = `routes.${routeName}.pets`;
                        if (!updatePayload[updatePath]) {
                            updatePayload[updatePath] = [];
                        }
                        updatePayload[updatePath].push({ id: crypto.randomUUID(), name: pet.name });
                    });

                    if (newRoutes.size > 0) {
                        const updatedRoutes = [...(AppState.config.manualRoutes || []), ...Array.from(newRoutes)];
                        await updateDoc(doc(db, 'settings', 'app_config'), { manualRoutes: updatedRoutes });
                    }
                    
                    const finalUnionPayload = {};
                    for (const path in updatePayload) {
                        finalUnionPayload[path] = arrayUnion(...updatePayload[path]);
                    }

                    if (Object.keys(finalUnionPayload).length > 0) {
                        await updateManualSchedule(dateStr, finalUnionPayload);
                        openInfoModal(`${petsToImport.length} pet(s) importado(s) com sucesso e distribuído(s) nas suas respectivas rotas!`, "Sucesso");
                    } else {
                        openInfoModal("Nenhum pet com rota válida foi encontrado para importar.", "Aviso");
                    }

                } catch (error) {
                    console.error("Erro ao processar o ficheiro CSV:", error);
                    openInfoModal(`Erro ao processar o ficheiro: ${error.message}`, "Erro de Importação");
                } finally {
                    importBtn.disabled = false;
                    importBtn.innerHTML = `<i class="fa-solid fa-file-csv mr-2"></i>Importar Planilha (CSV)`;
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        // --- ABA ENDEREÇOS ---
        function setupEnderecosTab() {
            document.getElementById('add-address-btn').addEventListener('click', () => openAddEditAddressModal());

            const searchInput = document.getElementById('address-search-input');
            searchInput.addEventListener('input', (e) => renderAddressesList(e.target.value));

            const addressesRef = collection(db, 'addresses');
            onSnapshot(query(addressesRef), (snapshot) => {
                AppState.addresses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAddressesList(searchInput.value);
            });
        }

        function renderAddressesList(filter = '') {
            const tableBody = document.getElementById('addresses-table-body');
            tableBody.innerHTML = '';
            const searchTerm = filter.toLowerCase().trim();

            const filteredAddresses = AppState.addresses.filter(addr => {
                if (!searchTerm) return true;
                return (
                    addr.petName?.toLowerCase().includes(searchTerm) ||
                    addr.tutorName?.toLowerCase().includes(searchTerm) ||
                    addr.address?.toLowerCase().includes(searchTerm) ||
                    addr.cep?.toLowerCase().includes(searchTerm)
                );
            });

            if (filteredAddresses.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">Nenhum endereço encontrado.</td></tr>`;
                return;
            }
            
            filteredAddresses.sort((a, b) => (a.petName || '').localeCompare(b.petName || ''));

            filteredAddresses.forEach(addr => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600';
                
                const addressText = addr.address || '';
                const encodedAddress = encodeURIComponent(addressText);
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
                
                const cepText = addr.cep || '';
                const encodedCep = encodeURIComponent(cepText);
                const cepGoogleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedCep}`;

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${addr.petName || ''}</td>
                    <td class="px-6 py-4">${addr.tutorName || ''}</td>
                    <td class="px-6 py-4">
                        ${addressText ? `<a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline flex items-center gap-2">
                            <i class="fa-solid fa-map-pin text-red-500"></i>
                            <span>${addressText}</span>
                        </a>` : ''}
                    </td>
                    <td class="px-6 py-4">
                        ${cepText ? `<a href="${cepGoogleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline flex items-center gap-2">
                            <i class="fa-solid fa-location-crosshairs text-gray-500"></i>
                            <span>${cepText}</span>
                        </a>` : ''}
                    </td>
                    <td class="px-6 py-4">${addr.observations || ''}</td>
                    <td class="px-6 py-4 text-right">
                        <button class="font-medium text-blue-600 dark:text-blue-500 hover:underline mr-3 edit-address-btn" data-address-id="${addr.id}"><i class="fa-solid fa-pencil"></i></button>
                        <button class="font-medium text-red-600 dark:text-red-500 hover:underline delete-address-btn" data-address-id="${addr.id}"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.edit-address-btn').forEach(btn => {
                btn.onclick = () => {
                    const address = AppState.addresses.find(a => a.id === btn.dataset.addressId);
                    if(address) openAddEditAddressModal(address);
                };
            });
            document.querySelectorAll('.delete-address-btn').forEach(btn => {
                btn.onclick = () => {
                    openConfirmationModal("Tem certeza que quer apagar este endereço?", () => {
                        deleteAddress(btn.dataset.addressId);
                    });
                };
            });
        }

        function openAddEditAddressModal(address = {}) {
            const isEditing = !!address.id;
            const modalHTML = `
                <h3 class="text-lg font-bold mb-6">${isEditing ? 'Editar Endereço' : 'Adicionar Novo Endereço'}</h3>
                <form id="address-form" class="space-y-4">
                    <input type="hidden" name="id" value="${address.id || ''}">
                    <div>
                        <label class="block text-sm font-medium mb-1">Nome do Pet</label>
                        <input name="petName" class="w-full p-2 border rounded dark:bg-gray-700" required value="${address.petName || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Nome do Tutor</label>
                        <input name="tutorName" class="w-full p-2 border rounded dark:bg-gray-700" value="${address.tutorName || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Endereço</label>
                        <input name="address" class="w-full p-2 border rounded dark:bg-gray-700" value="${address.address || 'Rua: '}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">CEP</label>
                        <input name="cep" placeholder="Ex: 12345-678" class="w-full p-2 border rounded dark:bg-gray-700" value="${address.cep || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Observações</label>
                        <textarea name="observations" class="w-full p-2 border rounded dark:bg-gray-700">${address.observations || ''}</textarea>
                    </div>
                    <div class="mt-6 flex justify-end gap-2">
                        <button type="button" id="modal-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Salvar</button>
                    </div>
                </form>
            `;
            openModal(modalHTML);
            document.getElementById('modal-cancel-btn').onclick = closeModal;
            document.getElementById('address-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const addressData = Object.fromEntries(formData.entries());
                saveAddress(addressData);
                closeModal();
            });
        }

        async function saveAddress(addressData) {
            const { id, ...data } = addressData;
            if (id) {
                const addressRef = doc(db, 'addresses', id);
                await updateDoc(addressRef, data);
            } else {
                await addDoc(collection(db, 'addresses'), {
                    ...data,
                    createdAt: serverTimestamp()
                });
            }
        }

        async function deleteAddress(addressId) {
            const addressRef = doc(db, 'addresses', addressId);
            await deleteDoc(addressRef);
        }

        // --- ABA FROTA ---
        async function ensureFleetDataExists() {
            const vehicleNames = ["Strada", "Montana", "Fiorino"];
            for (const name of vehicleNames) {
                const vehicleRef = doc(db, "fleet", name);
                const docSnap = await getDoc(vehicleRef);
                if (!docSnap.exists()) {
                    try {
                        await setDoc(vehicleRef, {
                            name: name,
                            pendingMaintenance: [],
                            history: []
                        });
                    } catch (error) {
                        console.error(`Failed to create document for ${name}:`, error);
                    }
                }
            }
        }
        
        function setupFrotaTab() {
            onSnapshot(collection(db, "fleet"), (snapshot) => {
                snapshot.docs.forEach(doc => {
                    AppState.fleet[doc.id] = { id: doc.id, ...doc.data() };
                });
                renderFleetCards();
            });
        }

        function renderFleetCards() {
            const grid = document.getElementById('fleet-grid');
            grid.innerHTML = '';
            const vehicleNames = ["Strada", "Montana", "Fiorino"];

            vehicleNames.forEach(name => {
                const vehicle = AppState.fleet[name];
                const card = document.createElement('div');
                card.className = 'fleet-card bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex flex-col items-center justify-center gap-3 cursor-pointer';
                
                const pendingCount = vehicle?.pendingMaintenance?.length || 0;

                card.innerHTML = `
                    <i class="fa-solid fa-truck text-5xl text-blue-500"></i>
                    <h3 class="text-2xl font-bold">${name}</h3>
                    <div class="text-center">
                        <p class="text-lg font-semibold ${pendingCount > 0 ? 'text-red-500' : 'text-green-500'}">${pendingCount}</p>
                        <p class="text-sm text-gray-500">Manutenções Pendentes</p>
                    </div>
                `;
                card.addEventListener('click', () => openFleetModal(name));
                grid.appendChild(card);
            });
        }

        function openFleetModal(vehicleId) {
            const vehicle = AppState.fleet[vehicleId] || { pendingMaintenance: [], history: [] };
            const sortedHistory = (vehicle.history || []).sort((a,b) => (b.completedAt?.seconds || 0) - (a.completedAt?.seconds || 0));

            let modalHTML = `
                <div class="flex justify-between items-start">
                    <h2 class="text-3xl font-bold mb-4">${vehicleId}</h2>
                    <button id="modal-close-btn" class="text-2xl">&times;</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div>
                        <h3 class="font-semibold text-xl mb-3 border-b pb-2">Manutenções Pendentes</h3>
                        <div id="pending-list" class="space-y-2">${renderTaskList(vehicle.pendingMaintenance, vehicleId, true)}</div>
                        <button id="add-task-btn" class="mt-4 w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Adicionar Tarefa</button>
                    </div>
                    <div>
                        <h3 class="font-semibold text-xl mb-3 border-b pb-2">Histórico</h3>
                        <div id="history-list" class="space-y-2">${renderTaskList(sortedHistory, vehicleId, false)}</div>
                    </div>
                </div>
            `;
            openModal(modalHTML);
            document.getElementById('modal-close-btn').onclick = closeModal;
            attachTaskListeners(vehicleId);
        }
        
        function renderTaskList(tasks, vehicleId, isPending) {
            if (!tasks || tasks.length === 0) return `<p class="text-sm text-gray-500">Nenhuma tarefa aqui.</p>`;
            return tasks.map(task => `
                <div class="flex items-center gap-3 bg-gray-100 dark:bg-gray-700 p-2 rounded-lg">
                     ${isPending ? `<button class="complete-task-btn text-green-500 hover:text-green-400" data-task-id="${task.id}"><i class="fa-solid fa-check-circle"></i></button>` : '<i class="fa-solid fa-check-circle text-green-500"></i>'}
                    <div class="flex-grow">
                         <p class="${!isPending ? 'task-completed' : ''}">${task.description}</p>
                         <div class="text-xs text-gray-400 flex gap-4">
                             ${task.createdAt ? `<span>Criado: ${new Date(task.createdAt.split('-').join('/')).toLocaleDateString()}</span>` : ''}
                             ${!isPending && task.completedAt?.toDate ? `<span>Concluído: ${task.completedAt.toDate().toLocaleDateString()}</span>` : ''}
                         </div>
                    </div>
                    <button class="edit-task-btn" data-task-id="${task.id}" data-is-pending="${isPending}"><i class="fa-solid fa-pencil text-gray-500 hover:text-blue-500"></i></button>
                    <button class="delete-task-btn" data-task-id="${task.id}" data-is-pending="${isPending}"><i class="fa-solid fa-trash text-gray-500 hover:text-red-500"></i></button>
                </div>
            `).join('');
        }

        function attachTaskListeners(vehicleId) {
            document.getElementById('add-task-btn')?.addEventListener('click', () => openTaskEditModal(vehicleId));
            document.querySelectorAll('.edit-task-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const taskId = e.currentTarget.dataset.taskId;
                const isPending = e.currentTarget.dataset.isPending === 'true';
                const taskList = isPending ? AppState.fleet[vehicleId].pendingMaintenance : AppState.fleet[vehicleId].history;
                const task = taskList.find(t => t.id === taskId);
                openTaskEditModal(vehicleId, task, isPending);
            }));
            document.querySelectorAll('.delete-task-btn').forEach(btn => btn.addEventListener('click', (e) => {
                 const taskId = e.currentTarget.dataset.taskId;
                 const isPending = e.currentTarget.dataset.isPending === 'true';
                 openConfirmationModal("Tem a certeza que quer apagar esta tarefa?", () => deleteTask(vehicleId, taskId, isPending));
            }));
            document.querySelectorAll('.complete-task-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const taskId = e.currentTarget.dataset.taskId;
                openConfirmationModal("Marcar esta tarefa como concluída?", () => completeTask(vehicleId, taskId));
            }));
        }

        function openTaskEditModal(vehicleId, task = {}, isPending = true) {
            const isEditing = !!task.id;
            const today = new Date().toISOString().split('T')[0];
            const modalHTML = `
                <h3 class="text-lg font-bold mb-4">${isEditing ? 'Editar Tarefa' : 'Nova Tarefa'}</h3>
                <form id="task-form" class="space-y-4">
                    <div>
                        <label for="task-desc" class="block text-sm font-medium">Descrição</label>
                        <textarea id="task-desc" name="task-desc" class="w-full p-2 border rounded dark:bg-gray-700" required>${task.description || ''}</textarea>
                    </div>
                    <div>
                        <label for="createdAt" class="block text-sm font-medium">Data de Criação</label>
                        <input type="date" id="createdAt" name="createdAt" class="w-full p-2 border rounded dark:bg-gray-700" value="${task.createdAt || today}" ${isEditing ? 'readonly' : ''}>
                    </div>
                    <div class="mt-4 flex justify-end gap-3">
                        <button type="button" id="modal-cancel-task-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Salvar</button>
                    </div>
                </form>
            `;
            openModal(modalHTML);
            document.getElementById('modal-cancel-task-btn').onclick = () => openFleetModal(vehicleId);
            document.getElementById('task-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const description = e.target['task-desc'].value;
                const createdAt = e.target['createdAt'].value;
                saveTask(vehicleId, { ...task, description, createdAt }, isEditing, isPending);
            });
        }
        
        async function saveTask(vehicleId, task, isEditing, isPending) {
            const vehicleRef = doc(db, "fleet", vehicleId);
            if (isEditing) {
                const listName = isPending ? 'pendingMaintenance' : 'history';
                const list = [...AppState.fleet[vehicleId][listName]];
                const taskIndex = list.findIndex(t => t.id === task.id);
                if (taskIndex > -1) list[taskIndex] = task;
                await updateDoc(vehicleRef, { [listName]: list });
            } else {
                task.id = crypto.randomUUID();
                await updateDoc(vehicleRef, { pendingMaintenance: arrayUnion(task) });
            }
            openFleetModal(vehicleId);
        }

        async function deleteTask(vehicleId, taskId, isPending) {
            const vehicleRef = doc(db, "fleet", vehicleId);
            const listName = isPending ? 'pendingMaintenance' : 'history';
            const taskToDelete = AppState.fleet[vehicleId][listName].find(t => t.id === taskId);
            await updateDoc(vehicleRef, { [listName]: arrayRemove(taskToDelete) });
            openFleetModal(vehicleId);
        }
        
        async function completeTask(vehicleId, taskId) {
            const vehicleRef = doc(db, "fleet", vehicleId);
            await runTransaction(db, async (transaction) => {
                const vehicleDoc = await transaction.get(vehicleRef);
                if (!vehicleDoc.exists()) throw "Document does not exist!";
                
                const data = vehicleDoc.data();
                const pendingList = data.pendingMaintenance || [];
                const historyList = data.history || [];
                
                const taskIndex = pendingList.findIndex(t => t.id === taskId);
                if (taskIndex === -1) return;

                const [taskToMove] = pendingList.splice(taskIndex, 1);
                
                const completedTask = { ...taskToMove, completedAt: serverTimestamp() };
                historyList.unshift(completedTask);

                transaction.update(vehicleRef, {
                    pendingMaintenance: pendingList,
                    history: historyList
                });
            });
            openFleetModal(vehicleId);
        }

    </script>
</body>
</html>
